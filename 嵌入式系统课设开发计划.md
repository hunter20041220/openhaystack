# 基于OpenHaystack的智能AirTag防丢器课设开发计划

## 一、项目概述

### 1.1 什么是AirTag？OpenHaystack是做什么的？

**AirTag简介：**
AirTag是Apple推出的蓝牙防丢追踪器，可以贴在钥匙、背包、钱包等物品上。当物品丢失时，附近的iPhone会自动检测到AirTag的蓝牙信号，并将位置信息匿名上传到Apple服务器，你就可以在"查找"App中看到物品的大概位置。

**OpenHaystack项目解读：**
OpenHaystack是一个**开源的DIY AirTag项目**，通过逆向工程Apple的Find My网络，让你可以用ESP32、micro:bit等便宜的开发板自制AirTag防丢器。

**核心工作原理（就像真正的AirTag）：**
1. **配对阶段**：在Mac上生成一对密钥（公钥+私钥），公钥烧录到ESP32里
2. **广播阶段**：ESP32通过蓝牙BLE不停广播公钥信号（就像说"我在这里"）
3. **被发现阶段**：附近的iPhone检测到信号后，用GPS定位，加密位置信息并上传到Apple服务器
4. **查找阶段**：你在Mac上打开OpenHaystack应用，用私钥解密位置报告，就能在地图上看到ESP32的位置

**当前项目状态：**
- ✅ 已实现：BLE广播（伪装成AirTag）、Find My网络定位
- ❌ 缺少：本地距离测量、蜂鸣报警、OLED显示、RFID功能、中断处理

**存在的问题：**
OpenHaystack原项目只能在Mac电脑上看到位置，**不能实时知道距离**，也不能在设备超出距离时报警。

---

### 1.2 课设目标：增强版智能AirTag

**核心创意：**
在OpenHaystack基础上，做一个**带距离监测和本地报警功能的双模AirTag**：
- **远距离模式**：物品丢失后，通过Find My网络在全球范围定位（利用别人的iPhone）
- **近距离模式**：蓝牙连接手机，实时显示距离，超出范围蜂鸣报警

### 1.3 课设要求对照

| 功能模块 | 课设要求 | AirTag功能设计 | 实现方案 |
|---------|---------|---------------|---------|
| **传感器数据采集** | ≥3种 | 1. BLE RSSI信号强度（距离）<br>2. 加速度计（运动检测）<br>3. 环境光传感器（光照检测） | MPU6050+BH1750+BLE RSSI |
| **RFID射频识别** | 优秀/良好必须 | 刷卡解除报警/授权管理 | RC522读卡器 |
| **输出控制** | ≥2种 | 1. OLED显示（距离/方位/状态）<br>2. 蜂鸣器（报警）<br>3. LED（状态指示） | SSD1306+蜂鸣器+LED |
| **中断功能** | 必须 | 1. 按键中断（模式切换）<br>2. 加速度中断（震动检测）<br>3. 定时器中断（定时扫描） | GPIO中断+运动中断 |
| **串口通信** | 必须 | 蓝牙串口+USB串口双通道 | BLE SPP+UART |
| **OLED显示** | 必须 | 实时显示距离/方位/电量/状态 | I2C OLED |
| **BLE通信** | 原有 | 保留Find My网络功能 | 原代码+增强 |

---

## 二、系统设计方案

### 2.1 智能AirTag系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     智能AirTag系统（ESP32）                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入/传感模块          处理核心            输出/控制模块          │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────┐       │
│  │ BLE RSSI    │───▶│              │───▶│ OLED显示    │       │
│  │ (距离测量)   │    │  FreeRTOS    │    │ (距离/方位)  │       │
│  │             │    │   任务调度    │    │             │       │
│  │ MPU6050     │───▶│              │───▶│ 蜂鸣器      │       │
│  │ (加速度/移动)│    │  Find My     │    │ (超距报警)   │       │
│  │             │    │  BLE广播     │    │             │       │
│  │ BH1750      │───▶│              │───▶│ LED指示灯   │       │
│  │ (光照检测)   │    │  距离计算    │    │ (状态显示)   │       │
│  │             │    │              │    │             │       │
│  │ RC522 RFID  │───▶│  中断处理    │───▶│ 串口输出    │       │
│  │ (刷卡解除)   │    │              │    │ (调试/控制)  │       │
│  │             │    │  NVS存储     │    │             │       │
│  │ 按键输入    │───▶│              │    │ 手机App     │       │
│  │ (模式切换)   │    │  数据分析    │    │ (BLE连接)   │       │
│  └─────────────┘    └──────────────┘    └─────────────┘       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

        ▲                                            │
        │                                            ▼
  附近的iPhone                                  你的Mac/手机
  (上报位置到                                  (查看全球定位)
   Apple服务器)
```

### 2.2 工作模式设计

#### 模式1：远距离追踪模式（Find My网络）
**适用场景**：物品已经丢失，不在身边
- ESP32持续广播Find My信号
- 附近iPhone自动上报位置到Apple服务器
- 在Mac/手机OpenHaystack App上查看位置
- **距离范围**：全球（只要有iPhone经过）

#### 模式2：近距离防丢模式（蓝牙连接）
**适用场景**：物品在附近，实时监控距离
- 手机与ESP32建立蓝牙连接
- 实时测量RSSI信号强度，计算距离
- OLED显示当前距离和方向
- 超出设定距离时蜂鸣器报警
- **距离范围**：0-50米

#### 模式3：安全模式（RFID授权）
**适用场景**：防止误报警，授权解除
- 靠近时自动检测RFID卡片
- 授权卡片可以临时解除报警
- 未授权卡片触发警报
- 记录刷卡日志

---

## 三、详细功能模块设计

### 3.1 传感器模块（3种+BLE RSSI）

#### 传感器1：BLE RSSI信号强度 → 距离测量
**这是最核心的传感器！**
- **原理**：测量手机蓝牙信号强度（RSSI），信号越弱距离越远
- **公式**：距离(米) = 10 ^ ((发射功率-RSSI) / (10 * 路径损耗系数))
- **采集频率**：每秒10次
- **用途**：
  - 实时计算与手机的距离
  - 超出设定距离（如10米）触发蜂鸣报警
  - 在OLED上显示距离条形图

**距离等级划分：**
```
RSSI > -50dBm  →  <1米   →  绿色LED  →  "很近"
RSSI -50~-70   →  1-5米  →  绿色LED  →  "正常"
RSSI -70~-85   →  5-15米 →  黄色LED  →  "警告"
RSSI < -85     →  >15米  →  红色LED  →  "危险"蜂鸣器响
```

#### 传感器2：MPU6050加速度计/陀螺仪
- **功能**：检测AirTag是否被移动/震动
- **接口**：I2C总线（与OLED共享）
- **采集频率**：100Hz（高速模式），运动检测用中断触发
- **应用场景**：
  - **防盗检测**：静止状态下突然移动→触发报警
  - **运动记录**：记录物品移动轨迹
  - **省电优化**：长时间静止→进入低功耗模式
  - **跌落检测**：加速度突变→记录事件
- **中断功能**：
  - 运动中断：加速度变化>阈值时触发
  - 自由落体中断：检测掉落

#### 传感器3：BH1750光照传感器
- **功能**：检测环境光照强度
- **接口**：I2C总线
- **采集频率**：每5秒一次
- **应用场景**：
  - **场景识别**：
    - 亮（>500 lux）→ 室外/开阔地
    - 中（50-500）→ 室内
    - 暗（<50）→ 包里/口袋/夜晚
  - **防盗辅助**：从亮到暗突变→可能被放入包中
  - **省电策略**：黑暗环境降低OLED亮度
  - **场景记录**：记录光照变化时间轴

**三传感器联动示例：**
```
场景：钱包被小偷偷走
1. MPU6050检测到移动（中断触发）
2. BLE RSSI显示距离越来越远
3. BH1750检测到从明亮到黑暗（放入口袋）
4. 系统判断：异常移动！触发蜂鸣报警
```

### 3.2 RFID模块设计（RC522）

#### 功能1：刷卡解除报警
- **场景**：借给朋友使用，避免误报警
- **操作流程**：
  1. AirTag检测到超距，开始蜂鸣报警
  2. 朋友拿出授权卡片靠近RFID读卡器
  3. 识别为授权卡，停止报警，LED变绿
  4. 授权时间：可设置临时授权（1小时）或永久授权

#### 功能2：主人身份验证
- **场景**：找到丢失的物品，确认是自己的
- **操作流程**：
  1. 找到AirTag后，用主卡靠近
  2. OLED显示：主人姓名、联系方式
  3. 可读取设备ID、历史记录

#### 功能3：授权管理
- **白名单管理**：
  - 最多存储20张授权卡
  - 主卡（管理员）：可添加/删除其他卡
  - 普通卡：只能解除报警
- **通过串口管理**：
  ```
  #RFID:ADD,12345678     - 添加卡片UID
  #RFID:DEL,12345678     - 删除卡片
  #RFID:LIST             - 列出所有卡片
  #RFID:CLEAR            - 清空白名单
  ```

#### 功能4：防拆保护
- **场景**：小偷试图拆除AirTag
- **机制**：设置"防拆模式"，需要刷主卡才能关机
- **未授权拆除**：触发最高级别报警+记录事件

**RFID应用场景示例：**
```
情景1：借给朋友
  你：给朋友一张临时卡
  朋友：带着物品离开，刷卡解除报警
  
情景2：物品丢失被好心人捡到
  好心人：看到AirTag在响
  你：远程通过Find My看到位置，打电话告知
  好心人：你告知RFID卡号，刷卡后OLED显示你的联系方式
  
情景3：家庭共享
  家人：都有授权卡，谁拿走物品都不会报警
```

### 3.3 输出控制模块

#### 输出1：OLED显示屏（SSD1306，128x64，I2C）

**多页面设计（按键切换）：**

**页面1：主界面（距离监控）**
```
┌──────────────────────┐
│  AirTag 防丢器       │
│━━━━━━━━━━━━━━━━━━━━│
│  距离: 5.2m          │
│  [████████░░] 52%    │  ← 距离条形图
│                      │
│  方位: 东北 45°      │
│  信号: -68 dBm       │
│                      │
│  状态: 正常   🔋85%  │
└──────────────────────┘
```

**页面2：传感器数据**
```
┌──────────────────────┐
│  传感器状态          │
│━━━━━━━━━━━━━━━━━━━━│
│  加速度:             │
│   X: +0.12g          │
│   Y: -0.05g          │
│   Z: +0.98g          │
│                      │
│  光照: 450 lux       │
│  场景: 室内          │
└──────────────────────┘
```

**页面3：Find My网络状态**
```
┌──────────────────────┐
│  Find My网络         │
│━━━━━━━━━━━━━━━━━━━━│
│  广播: 活动中        │
│  密钥: A3F2...       │
│                      │
│  最后上报:           │
│  2分钟前             │
│                      │
│  上报次数: 127       │
└──────────────────────┘
```

**页面4：系统信息**
```
┌──────────────────────┐
│  系统信息            │
│━━━━━━━━━━━━━━━━━━━━│
│  设备ID: OH-2024     │
│  MAC: B4:E6:2D:...   │
│                      │
│  运行时间: 3h 24m    │
│  内存: 45% (140KB)   │
│                      │
│  固件: v1.0.0        │
└──────────────────────┘
```

**页面5：RFID授权状态**
```
┌──────────────────────┐
│  RFID授权            │
│━━━━━━━━━━━━━━━━━━━━│
│  最后刷卡:           │
│  UID: A1B2C3D4       │
│  姓名: 张三          │
│  时间: 10:24         │
│                      │
│  授权卡: 3/20        │
│  状态: ✓ 已授权      │
└──────────────────────┘
```

#### 输出2：蜂鸣器报警系统

**多级报警音效：**
```c
// 警告级别（黄色LED，距离10-15米）
void beep_warning() {
    // 每5秒响一次，短促"哔"
    beep(100ms, 每5秒);
}

// 危险级别（红色LED，距离>15米）
void beep_danger() {
    // 每2秒响一次，"哔哔"
    beep(200ms, 停200ms, 再200ms, 每2秒);
}

// 紧急级别（运动检测+超距）
void beep_emergency() {
    // 连续快速响，"哔哔哔哔"
    beep(100ms, 停100ms, 循环);
}

// RFID未授权
void beep_unauthorized() {
    // 低频长音，"哔————"
    beep(1000ms, 低频);
}

// 操作成功
void beep_success() {
    // 上升音调，"哔↗"
    beep(50ms, 频率上升);
}
```

**可通过串口控制：**
```
#SET:BEEP,WARNING   - 警告音
#SET:BEEP,DANGER    - 危险音
#SET:BEEP,OFF       - 关闭蜂鸣器
#SET:BEEP,TEST      - 测试所有音效
#CFG:DISTANCE,10    - 设置报警距离阈值(米)
```

#### 输出3：RGB LED状态指示灯

**颜色状态映射：**
| LED颜色 | 状态 | 说明 |
|---------|------|------|
| 🟢 绿色常亮 | 正常 | 距离<5米，已授权 |
| 🔵 蓝色闪烁 | Find My广播 | 正在发送BLE信标 |
| 🟡 黄色闪烁 | 警告 | 距离5-15米 |
| 🔴 红色快闪 | 危险 | 距离>15米或异常移动 |
| 🟣 紫色呼吸 | 待机 | 低功耗模式 |
| ⚪ 白色 | RFID刷卡 | 正在读卡 |
| 🌈 彩虹流动 | 启动 | 系统初始化 |

**PWM控制实现呼吸灯效果：**
```c
void led_breathing() {
    for(int i=0; i<255; i++) {
        set_led_brightness(i);
        delay(5ms);
    }
    for(int i=255; i>=0; i--) {
        set_led_brightness(i);
        delay(5ms);
    }
}
```

### 3.4 中断功能模块

#### 中断1：按键中断（3个按键）

**按键1（GPIO0）：模式切换/确认**
- 短按：切换OLED显示页面
- 长按3秒：切换工作模式（Find My ↔ 防丢模式）
- 双击：手动触发Find My上报

**按键2（GPIO35）：报警控制**
- 短按：临时静音蜂鸣器（5分钟）
- 长按3秒：永久关闭报警（需RFID授权）
- 三击：紧急求救（最大音量持续报警）

**按键3（GPIO34）：功能键**
- 短按：点亮/熄灭OLED背光
- 长按：进入设置菜单
- 开机时长按：进入配置模式（AP模式，Web配置）

**防抖处理：**
```c
// 硬件防抖（电容）+ 软件防抖（定时器）
void IRAM_ATTR button_isr_handler(void* arg) {
    xTimerStart(debounce_timer, 0);  // 启动50ms防抖定时器
}

void debounce_timer_callback() {
    if(gpio_get_level(BUTTON_PIN) == 0) {  // 确认仍然按下
        // 处理按键事件
    }
}
```

#### 中断2：MPU6050运动检测中断（GPIO26）

**中断触发条件：**
- **运动中断**：加速度变化 > 0.5g
- **零运动中断**：持续5秒无运动
- **自由落体中断**：三轴加速度同时<0.3g，持续>50ms

**应用逻辑：**
```c
void IRAM_ATTR motion_isr_handler(void* arg) {
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    
    // 读取中断源
    uint8_t int_status = mpu6050_read_int_status();
    
    if(int_status & MPU6050_MOTION_INT) {
        // 检测到运动
        if(device_state == STATE_STATIC) {
            // 静止状态下突然移动 → 可能被偷！
            xTaskNotifyFromISR(alert_task_handle, ALERT_THEFT, 
                              eSetBits, &xHigherPriorityTaskWoken);
        }
    }
    
    if(int_status & MPU6050_FREEFALL_INT) {
        // 检测到跌落
        log_event("FREEFALL_DETECTED", get_timestamp());
    }
    
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}
```

#### 中断3：定时器中断

**定时器0：RSSI扫描定时器（100ms）**
```c
void IRAM_ATTR rssi_timer_isr(void *arg) {
    // 触发BLE RSSI扫描任务
    xTaskNotifyFromISR(ble_scan_task_handle, 0, eNoAction, NULL);
}
```

**定时器1：传感器采集定时器（1秒）**
```c
void IRAM_ATTR sensor_timer_isr(void *arg) {
    // 触发传感器读取任务
    xEventGroupSetBitsFromISR(sensor_event_group, SENSOR_READ_BIT, NULL);
}
```

**定时器2：看门狗定时器（10秒）**
```c
void watchdog_task(void *pvParameters) {
    while(1) {
        esp_task_wdt_reset();  // 喂狗
        vTaskDelay(pdMS_TO_TICKS(5000));
    }
}
```

### 3.5 串口通信模块

#### 通信方式1：USB串口（UART0，调试+配置）

**波特率**：115200 8N1

**命令协议（主动查询）：**
```
格式: #CMD:PARAM1,PARAM2\r\n
响应: @OK:DATA\r\n 或 @ERR:错误码\r\n

查询命令：
#GET:DISTANCE          - 查询当前距离
#GET:RSSI              - 查询信号强度
#GET:MOTION            - 查询运动状态
#GET:LIGHT             - 查询光照
#GET:ALL               - 查询所有传感器
#GET:STATUS            - 查询系统状态
#GET:BATTERY           - 查询电量

控制命令：
#SET:BEEP,ON           - 开启蜂鸣器
#SET:BEEP,OFF          - 关闭蜂鸣器
#SET:LED,RED           - 设置LED颜色
#SET:OLED,PAGE,2       - 切换OLED页面
#SET:MODE,FINDMY       - 切换到Find My模式
#SET:MODE,ANTI_LOST    - 切换到防丢模式

配置命令：
#CFG:DISTANCE,10       - 设置报警距离(米)
#CFG:RSSI,-80          - 设置RSSI阈值(dBm)
#CFG:NAME,我的钥匙     - 设置设备名称
#CFG:CONTACT,手机号    - 设置联系方式

RFID命令：
#RFID:ADD,A1B2C3D4,张三  - 添加授权卡
#RFID:DEL,A1B2C3D4       - 删除卡片
#RFID:LIST               - 列出所有卡片
#RFID:CLEAR              - 清空白名单

系统命令：
#SYS:INFO              - 系统信息
#SYS:RESET             - 复位系统
#SYS:FACTORY           - 恢复出厂设置
#SYS:LOG               - 查看日志
```

**数据上报（自动推送）：**
```
// 距离变化
@DATA:DISTANCE=5.2,RSSI=-68,LEVEL=NORMAL\r\n

// 报警事件
@ALERT:DISTANCE_EXCEED,15.3m\r\n
@ALERT:MOTION_DETECTED,THEFT_SUSPECTED\r\n
@ALERT:RFID_UNAUTHORIZED,UID=12345678\r\n

// 传感器数据（可设置上报间隔）
@SENSOR:ACCEL_X=0.12,ACCEL_Y=-0.05,ACCEL_Z=0.98\r\n
@SENSOR:LIGHT=450,SCENE=INDOOR\r\n

// RFID事件
@RFID:CARD_DETECTED,UID=A1B2C3D4,NAME=张三,AUTH=OK\r\n

// Find My网络事件
@FINDMY:BEACON_SENT,COUNT=128\r\n
```

#### 通信方式2：BLE串口（SPP配置文件）

**用途**：手机App通过蓝牙连接，实时监控
- 同样的命令协议
- 实时推送距离/RSSI数据（每秒10次）
- 低延迟（<100ms）

**手机App功能设想（可选扩展）：**
- 实时距离曲线图
- 地图显示Find My位置
- 远程控制蜂鸣器（找物品）
- 配置参数（距离阈值、报警开关）
- 历史轨迹回放

### 3.6 数据存储模块（NVS）

**存储内容：**
```c
typedef struct {
    // 设备配置
    char device_name[32];           // 设备名称
    char contact_info[64];          // 联系方式
    uint8_t public_key[28];         // Find My公钥
    
    // 报警配置
    float distance_threshold;       // 距离阈值(米)
    int8_t rssi_threshold;          // RSSI阈值(dBm)
    bool beep_enabled;              // 蜂鸣器开关
    uint8_t beep_volume;            // 音量(0-100)
    
    // RFID白名单
    struct {
        uint8_t uid[4];             // 卡片UID
        char name[16];              // 持有人姓名
        uint8_t permission;         // 权限级别
        uint32_t expire_time;       // 过期时间
    } rfid_whitelist[20];
    int rfid_count;
    
    // 统计数据
    uint32_t total_runtime;         // 总运行时间(秒)
    uint32_t alert_count;           // 报警次数
    uint32_t rfid_auth_count;       // RFID授权次数
    uint32_t findmy_report_count;   // Find My上报次数
    
    // 事件日志（最近100条）
    struct {
        uint32_t timestamp;
        uint8_t event_type;
        char description[32];
    } event_log[100];
    int log_count;
    
} device_config_t;
```

---

## 三、开发部署步骤

### 3.1 软件环境准备

#### 3.1.1 Windows开发环境搭建

**步骤1：安装ESP-IDF**
```powershell
# 1. 下载ESP-IDF Windows安装器
# 访问：https://dl.espressif.com/dl/esp-idf/
# 下载：esp-idf-tools-setup-online.exe

# 2. 运行安装器，选择版本v4.4或v5.0
# 安装路径建议：C:\Espressif

# 3. 安装完成后，会自动创建ESP-IDF命令行快捷方式
```

**步骤2：安装Python依赖**
```powershell
# ESP-IDF安装器会自动安装Python 3.8+
# 如需手动安装依赖：
python -m pip install --upgrade pip
pip install pyserial esptool
```

**步骤3：配置VSCode（推荐）**
```powershell
# 1. 安装VSCode扩展
# - ESP-IDF Extension
# - C/C++ Extension

# 2. 配置ESP-IDF路径
# Ctrl+Shift+P -> ESP-IDF: Configure ESP-IDF Extension
```

#### 3.1.2 macOS开发环境（原OpenHaystack应用）

**步骤1：安装Xcode**
```bash
# 从App Store安装Xcode
xcode-select --install
```

**步骤2：配置Mail插件（查看位置数据）**
- 按照README.md中的Installation步骤
- 需要临时禁用Gatekeeper
- 需要macOS 11 (Big Sur)或更高版本

### 3.2 硬件连接说明

#### 3.2.1 ESP32引脚分配表

| 模块 | 接口类型 | ESP32引脚 | 说明 |
|------|---------|----------|------|
| **传感器模块** ||||
| DHT22温湿度 | 1-Wire | GPIO4 | 数据线需4.7K上拉 |
| BH1750光照 | I2C | SDA=GPIO21, SCL=GPIO22 | 共享I2C总线 |
| HC-SR501红外 | GPIO | GPIO26 | 外部中断输入 |
| HC-SR04超声波 | GPIO | Trig=GPIO5, Echo=GPIO18 | 可选 |
| **RFID模块** ||||
| RC522 RFID | SPI | MOSI=GPIO23, MISO=GPIO19, SCK=GPIO18, CS=GPIO15, RST=GPIO2 | 独立SPI总线 |
| **输出模块** ||||
| OLED SSD1306 | I2C | SDA=GPIO21, SCL=GPIO22 | 与BH1750共享I2C |
| RGB LED | GPIO | R=GPIO12, G=GPIO13, B=GPIO14 | PWM控制 |
| 蜂鸣器 | GPIO | GPIO25 | PWM或开关控制 |
| 继电器 | GPIO | GPIO27 | 低电平触发 |
| **按键模块** ||||
| 按键1 | GPIO | GPIO0 | 下拉，按下接高 |
| 按键2 | GPIO | GPIO35 | 下拉，按下接高 |
| 按键3 | GPIO | GPIO34 | 下拉，按下接高 |
| **电源** ||||
| VCC | - | 5V/3.3V | 根据模块要求 |
| GND | - | GND | 公共地 |

**接线注意事项：**
1. ESP32的GPIO0在启动时不能被拉低，否则进入下载模式
2. I2C总线需要4.7K上拉电阻（部分模块内置）
3. RFID RC522模块工作电压3.3V，不能接5V
4. 继电器模块可能需要独立5V供电
5. 所有模块必须共地（GND相连）

#### 3.2.2 硬件连接图（简化版）

```
                     ┌─────────────────┐
                     │   ESP32开发板    │
                     │                 │
    DHT22 ──────────┤ GPIO4           │
                     │                 │
    BH1750 ─────┬───┤ GPIO21 (SDA)    │
                │   │ GPIO22 (SCL)    │
    OLED ───────┘   │                 │
                     │                 │
    HC-SR501 ───────┤ GPIO26          │
                     │                 │
    RC522 ──────────┤ GPIO23 (MOSI)   │
      (RFID)        │ GPIO19 (MISO)   │
                    │ GPIO18 (SCK)    │
                    │ GPIO15 (CS)     │
                    │ GPIO2  (RST)    │
                     │                 │
    LED(R) ─────────┤ GPIO12          │
    LED(G) ─────────┤ GPIO13          │
    LED(B) ─────────┤ GPIO14          │
                     │                 │
    蜂鸣器 ─────────┤ GPIO25          │
    继电器 ─────────┤ GPIO27          │
                     │                 │
    按键1 ──────────┤ GPIO0           │
    按键2 ──────────┤ GPIO35          │
    按键3 ──────────┤ GPIO34          │
                     │                 │
    5V ─────────────┤ VIN/5V          │
    GND ────────────┤ GND             │
                     └─────────────────┘
```

### 3.3 代码开发步骤

#### 3.3.1 项目文件结构

```
openhaystack/
├── Firmware/
│   └── ESP32_Enhanced/          # 新建增强版固件目录
│       ├── main/
│       │   ├── main.c           # 主程序
│       │   ├── sensors.c/h      # 传感器驱动
│       │   ├── rfid.c/h         # RFID驱动
│       │   ├── display.c/h      # OLED显示
│       │   ├── output.c/h       # 输出控制
│       │   ├── uart_protocol.c/h # 串口协议
│       │   ├── interrupt.c/h    # 中断处理
│       │   ├── storage.c/h      # NVS存储
│       │   ├── ble_tracker.c/h  # 原BLE追踪功能
│       │   └── CMakeLists.txt
│       ├── components/          # 第三方库
│       │   ├── DHT22/
│       │   ├── BH1750/
│       │   ├── RC522/
│       │   └── SSD1306/
│       ├── CMakeLists.txt
│       ├── sdkconfig
│       └── README.md
├── 嵌入式系统课设开发计划.md  # 本文档
└── ...
```

#### 3.3.2 开发顺序（分阶段实现）

**阶段1：基础框架搭建（1-2天）**
1. 复制`Firmware/ESP32`目录到`ESP32_Enhanced`
2. 创建模块化的源文件框架
3. 配置FreeRTOS任务结构
4. 实现基本的串口调试输出

**阶段2：传感器模块开发（2-3天）**
1. 实现DHT22驱动和数据采集
2. 实现BH1750驱动（I2C通信）
3. 实现HC-SR501读取（GPIO输入）
4. 测试各传感器数据准确性

**阶段3：OLED显示模块（1-2天）**
1. 移植SSD1306驱动库（I2C）
2. 实现多页面显示框架
3. 设计UI界面（传感器数据、状态信息）
4. 实现显示刷新任务

**阶段4：输出控制模块（1-2天）**
1. 实现LED控制（GPIO或PWM）
2. 实现蜂鸣器控制（PWM）
3. 实现继电器控制
4. 测试各输出设备

**阶段5：RFID模块（2-3天）**
1. 移植RC522驱动库（SPI通信）
2. 实现卡片读取功能
3. 实现NVS白名单存储
4. 实现授权验证逻辑

**阶段6：中断功能（1-2天）**
1. 实现按键外部中断（防抖）
2. 实现人体红外中断
3. 实现定时器中断
4. 测试中断响应时间

**阶段7：串口通信协议（1-2天）**
1. 设计并实现通信协议
2. 实现命令解析器
3. 实现数据上报功能
4. 编写PC端测试工具（Python）

**阶段8：系统集成与测试（2-3天）**
1. 整合所有模块
2. 优化任务调度和优先级
3. 压力测试和稳定性测试
4. 编写用户手册和演示文档

**阶段9：BLE功能优化（1天）**
1. 保留原OpenHaystack的BLE广播功能
2. 将BLE状态显示在OLED上
3. 测试Find My网络追踪功能

#### 3.3.3 关键代码示例

**main.c主程序框架：**
```c
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "esp_log.h"

// 任务句柄
TaskHandle_t sensor_task_handle;
TaskHandle_t display_task_handle;
TaskHandle_t ble_task_handle;
TaskHandle_t uart_task_handle;

// 任务函数
void sensor_task(void *pvParameters) {
    while(1) {
        // 读取DHT22
        // 读取BH1750
        // 处理数据
        vTaskDelay(pdMS_TO_TICKS(2000));
    }
}

void display_task(void *pvParameters) {
    while(1) {
        // 更新OLED显示
        vTaskDelay(pdMS_TO_TICKS(500));
    }
}

void ble_task(void *pvParameters) {
    // 原OpenHaystack BLE广播逻辑
    while(1) {
        // BLE广播
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}

void uart_task(void *pvParameters) {
    while(1) {
        // 接收串口命令
        // 解析并执行
        vTaskDelay(pdMS_TO_TICKS(100));
    }
}

void app_main(void) {
    // 初始化NVS
    // 初始化GPIO
    // 初始化I2C总线
    // 初始化SPI总线
    // 初始化UART
    
    // 创建任务
    xTaskCreate(sensor_task, "sensor", 4096, NULL, 5, &sensor_task_handle);
    xTaskCreate(display_task, "display", 4096, NULL, 4, &display_task_handle);
    xTaskCreate(ble_task, "ble", 4096, NULL, 3, &ble_task_handle);
    xTaskCreate(uart_task, "uart", 4096, NULL, 6, &uart_task_handle);
    
    // 初始化中断
    // 初始化RFID
}
```

### 3.4 固件烧录步骤

```powershell
# 1. 进入项目目录
cd d:\progress\code\openhaystack\Firmware\ESP32_Enhanced

# 2. 配置项目（首次）
idf.py menuconfig

# 3. 编译项目
idf.py build

# 4. 查看可用串口
mode  # 或使用设备管理器查看

# 5. 烧录固件（假设是COM3）
idf.py -p COM3 flash

# 6. 查看串口输出（监控）
idf.py -p COM3 monitor

# 7. 一步完成编译、烧录、监控
idf.py -p COM3 flash monitor

# 退出监控：Ctrl+]
```

### 3.5 调试与测试

**串口调试工具：**
- ESP-IDF Monitor（推荐）
- PuTTY
- Tera Term
- Arduino IDE串口监视器
- Python pyserial脚本

**测试用Python脚本示例：**
```python
import serial
import time

ser = serial.Serial('COM3', 115200, timeout=1)

# 查询所有传感器数据
ser.write(b'#GET:ALL\r\n')
response = ser.readline()
print(response.decode())

# 控制LED
ser.write(b'#SET:LED,ON\r\n')
time.sleep(1)
ser.write(b'#SET:LED,OFF\r\n')

ser.close()
```

---

## 四、硬件采购清单

### 4.1 必需硬件清单

| 序号 | 名称 | 型号/规格 | 数量 | 单价（元） | 总价（元） | 购买链接建议 |
|------|------|-----------|------|-----------|-----------|-------------|
| **主控模块** ||||||
| 1 | ESP32开发板 | ESP32-WROOM-32（30pin） | 1 | 20-30 | 25 | 淘宝/立创商城 |
| **传感器模块** ||||||
| 2 | 温湿度传感器 | DHT22（AM2302） | 1 | 8-15 | 12 | 淘宝 |
| 3 | 光照传感器 | BH1750模块（I2C） | 1 | 3-5 | 4 | 淘宝 |
| 4 | 人体红外传感器 | HC-SR501 | 1 | 2-4 | 3 | 淘宝 |
| **RFID模块（优秀/良好必须）** ||||||
| 5 | RFID读卡器 | RC522模块（13.56MHz） | 1 | 5-10 | 8 | 淘宝 |
| 6 | RFID卡片 | S50白卡（IC卡） | 5 | 0.5-1 | 3 | 淘宝（通常送） |
| **显示模块** ||||||
| 7 | OLED显示屏 | SSD1306（128x64，I2C） | 1 | 8-15 | 12 | 淘宝/立创 |
| **输出控制模块** ||||||
| 8 | LED灯 | RGB共阴LED或3个独立LED | 1/3 | 1-3 | 2 | 淘宝 |
| 9 | 蜂鸣器 | 有源蜂鸣器5V或无源蜂鸣器 | 1 | 1-2 | 1.5 | 淘宝 |
| 10 | 继电器模块 | 5V单路继电器模块 | 1 | 2-5 | 3 | 淘宝 |
| **输入模块** ||||||
| 11 | 按键 | 轻触按键开关（6x6mm） | 3 | 0.1-0.5 | 1 | 淘宝 |
| **电源模块** ||||||
| 12 | USB线 | Micro USB数据线 | 1 | 2-5 | 3 | 淘宝（通常有） |
| 13 | 面包板电源 | 5V/3.3V面包板电源模块 | 1 | 3-6 | 5 | 淘宝 |
| **连接材料** ||||||
| 14 | 面包板 | 830孔面包板 | 1 | 5-10 | 8 | 淘宝 |
| 15 | 杜邦线 | 公对公/母对母/公对母各20根 | 1套 | 5-10 | 8 | 淘宝 |
| 16 | 电阻 | 4.7KΩ、10KΩ、330Ω各10个 | 1包 | 2-5 | 3 | 淘宝 |
| **必需硬件总计** ||||| **约101.5元** ||

### 4.2 可选扩展硬件

| 序号 | 名称 | 型号/规格 | 数量 | 单价（元） | 总价（元） | 用途 |
|------|------|-----------|------|-----------|-----------|------|
| 1 | 超声波测距 | HC-SR04 | 1 | 2-4 | 3 | 第4个传感器 |
| 2 | 风扇模块 | 5V小风扇 | 1 | 3-6 | 5 | 继电器控制对象 |
| 3 | PCB板 | 洞洞板/万能板 | 1 | 3-8 | 5 | 固定电路 |
| 4 | 外壳 | 透明亚克力外壳 | 1 | 10-20 | 15 | 美观展示 |
| 5 | 锂电池 | 18650锂电池+电池盒 | 1套 | 15-25 | 20 | 移动供电 |
| **可选硬件总计** ||||| **约48元** ||

### 4.3 开发工具（如果没有）

| 名称 | 规格 | 价格 | 说明 |
|------|------|------|------|
| 电脑 | Windows/macOS | - | 必需 |
| USB-TTL转换器 | CH340/CP2102 | 5-10元 | ESP32开发板通常内置 |
| 万用表 | 数字万用表 | 20-50元 | 调试用，可选 |
| 烙铁 | 恒温烙铁 | 30-100元 | 焊接用，可选 |

### 4.4 总预算估算

- **最低预算（必需硬件）**：约**100-120元**
- **推荐预算（必需+部分可选）**：约**150-180元**
- **完整预算（全部硬件+工具）**：约**200-250元**

### 4.5 购买建议

**推荐购买渠道：**
1. **淘宝/天猫**：价格实惠，选择多，搜索"ESP32开发板套件"可能有组合优惠
2. **立创商城**：元器件质量好，正品保证，适合单独采购芯片和传感器
3. **京东**：快递快，售后好，但价格略高
4. **拼多多**：价格最低，但质量参差不齐

**套件推荐：**
- 搜索"ESP32物联网开发套件"，有些套件已包含传感器和显示屏
- 价格区间：80-150元
- 优点：配件齐全，节省选购时间
- 缺点：可能缺少RFID模块，需单独购买

**购买注意事项：**
1. ESP32选择30pin或38pin版本，引脚更多更灵活
2. OLED屏幕确认是I2C接口（4针），不要买SPI版本（7针）
3. RC522 RFID模块确认包含天线和IC卡
4. 杜邦线建议买公对公、公对母、母对母三种
5. 确认传感器工作电压（3.3V还是5V）

---

## 五、评分要点对照表

根据课设要求，对照功能实现情况：

| 评分项 | 要求 | 实现方案 | 分值占比 |
|-------|------|---------|---------|
| **传感器数据采集** | ≥3种 | DHT22（温湿度）+ BH1750（光照）+ HC-SR501（人体红外）= 3种 | 25% |
| **RFID射频识别** | 优秀/良好必须 | RC522模块，实现卡片读取、白名单管理、授权验证 | 15% |
| **输出控制** | ≥2种 | OLED显示 + LED控制 + 蜂鸣器 + 继电器 = 4种 | 20% |
| **中断功能** | 必须有 | 按键外部中断（3个）+ 人体红外中断 + 定时器中断 | 15% |
| **串口通信** | 必须有 | 完整通信协议，支持命令交互和数据上报 | 10% |
| **OLED显示** | 必须有 | 多页面显示，实时更新传感器数据和状态 | 10% |
| **代码质量** | 模块化、注释 | 模块化设计，详细注释，符合编码规范 | 5% |

**额外加分项：**
- ✅ BLE通信（保留OpenHaystack功能）
- ✅ 数据存储（NVS）
- ✅ FreeRTOS多任务
- ✅ 完整的用户手册和演示

---

## 六、演示与答辩准备

### 6.1 演示内容规划

**演示流程（10-15分钟）：**

1. **系统介绍（2分钟）**
   - 展示硬件连接
   - 介绍系统架构
   - 说明功能模块

2. **基本功能演示（5分钟）**
   - 上电启动，观察OLED显示
   - 串口输出系统信息
   - 按键切换OLED页面
   - 实时显示传感器数据（温度、湿度、光照）

3. **传感器功能演示（2分钟）**
   - 呼气加热DHT22，观察温度变化
   - 遮挡BH1750，观察光照变化和LED响应
   - 手在HC-SR501前挥动，触发检测

4. **RFID功能演示（2分钟）**
   - 刷授权卡片，显示"授权成功"，绿灯亮
   - 刷未授权卡片，显示"未授权"，红灯闪烁，蜂鸣器报警

5. **输出控制演示（2分钟）**
   - 串口命令控制LED颜色
   - 串口命令触发蜂鸣器
   - 温度超阈值，继电器自动开启风扇

6. **中断功能演示（1分钟）**
   - 按键中断切换显示页面
   - 人体检测中断触发记录

7. **串口通信演示（1分钟）**
   - PC端发送查询命令
   - 接收实时数据上报

### 6.2 答辩可能问题

**硬件相关：**
1. Q: 为什么选择ESP32？
   - A: ESP32集成WiFi/BLE，性能强大，支持FreeRTOS，社区资源丰富

2. Q: I2C总线如何连接多个设备？
   - A: I2C支持多设备，通过设备地址区分（BH1750:0x23, SSD1306:0x3C）

3. Q: RFID的工作频率和通信距离？
   - A: RC522工作在13.56MHz，通信距离约3-5cm，适合近场识别

**软件相关：**
4. Q: 如何处理传感器数据采集的时序？
   - A: 使用FreeRTOS任务，每个传感器独立任务，通过队列传递数据

5. Q: 中断的优先级如何设置？
   - A: 按键中断最低，人体检测中断中等，定时器中断最高

6. Q: 串口通信协议如何设计？
   - A: 采用文本协议，命令以#开头，响应以@开头，便于调试

**系统相关：**
7. Q: 系统如何保证稳定性？
   - A: 看门狗定时器、异常处理、任务监控、数据校验

8. Q: 如何扩展更多传感器？
   - A: 模块化设计，只需添加驱动文件和任务即可

9. Q: BLE追踪功能如何工作？
   - A: 广播Apple Find My格式的BLE包，iPhone被动上报位置到Apple服务器

### 6.3 文档准备清单

1. **开发文档**（本文档）
2. **用户手册**：如何使用系统，串口命令说明
3. **代码注释**：每个函数、模块的详细注释
4. **测试报告**：功能测试结果，性能指标
5. **演示PPT**：系统架构图、功能演示截图
6. **演示视频**（可选）：提前录制演示过程

---

## 七、时间规划建议

### 总开发周期：2-3周

| 周次 | 任务 | 时间 |
|------|------|------|
| **第1周** | 硬件采购、环境搭建、基础学习 | 7天 |
| - Day 1-2 | 下单采购硬件，学习ESP-IDF基础 | |
| - Day 3-4 | 搭建开发环境，跑通Hello World | |
| - Day 5-7 | 学习传感器驱动、I2C/SPI通信 | |
| **第2周** | 核心功能开发 | 7天 |
| - Day 8-9 | 传感器数据采集 | |
| - Day 10-11 | OLED显示 + 输出控制 | |
| - Day 12-13 | RFID模块 + 中断功能 | |
| - Day 14 | 串口通信协议 | |
| **第3周** | 集成测试与文档 | 7天 |
| - Day 15-17 | 系统集成、调试优化 | |
| - Day 18-19 | 编写文档、准备演示 | |
| - Day 20-21 | 答辩预演、备份方案 | |

---

## 八、常见问题与解决方案

### 8.1 硬件问题

**问题1：ESP32无法识别/无法下载**
- 检查USB线是否为数据线（非纯充电线）
- 按住BOOT键再按RESET键进入下载模式
- 安装CH340/CP2102驱动程序

**问题2：I2C设备无法通信**
- 检查SDA/SCL接线是否正确
- 确认上拉电阻（4.7K）
- 用`i2cdetect`扫描设备地址

**问题3：RFID读卡失败**
- 检查SPI接线（特别是CS和RST）
- 确认RC522工作电压为3.3V
- 卡片距离天线3-5cm

### 8.2 软件问题

**问题4：编译错误**
- 检查ESP-IDF版本兼容性
- 清除构建缓存：`idf.py fullclean`
- 检查头文件路径配置

**问题5：任务死锁/系统卡死**
- 增加任务栈大小（4096 -> 8192）
- 检查互斥锁使用
- 启用看门狗定时器

**问题6：传感器数据异常**
- 添加数据校验和滤波
- 增加读取延时
- 检查电源稳定性（加去耦电容）

---

## 九、参考资料

### 9.1 官方文档
- [ESP-IDF编程指南](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/)
- [FreeRTOS官方文档](https://www.freertos.org/zh-cn-cmn-s/)
- [OpenHaystack GitHub](https://github.com/seemoo-lab/openhaystack)

### 9.2 传感器数据手册
- DHT22数据手册
- BH1750数据手册
- RC522数据手册
- SSD1306数据手册

### 9.3 推荐教程
- ESP32入门教程（B站/CSDN）
- I2C/SPI通信协议详解
- FreeRTOS任务调度教程

---

## 十、总结

本课设方案基于OpenHaystack项目，在保留原有BLE追踪功能的基础上，增加了：
- ✅ **3种传感器**（温湿度、光照、人体红外）
- ✅ **RFID射频识别**（RC522模块，白名单管理）
- ✅ **4种输出控制**（OLED、LED、蜂鸣器、继电器）
- ✅ **多种中断**（按键、人体检测、定时器）
- ✅ **完整串口通信**（命令解析、数据上报）
- ✅ **OLED显示**（多页面、实时刷新）

**项目特色：**
1. **实用性强**：结合物联网追踪和环境监测
2. **技术全面**：涵盖BLE、I2C、SPI、GPIO、UART等多种通信方式
3. **易于扩展**：模块化设计，便于添加新功能
4. **成本低廉**：总成本约100-150元

**预期成绩：优秀（90+）**

---

**文档版本**：v1.0  
**最后更新**：2025年12月11日  
**作者**：GitHub Copilot  
**联系方式**：[您的邮箱]

---

## 附录A：快速上手检查清单

- [ ] 硬件采购完成
- [ ] ESP-IDF环境搭建完成
- [ ] 能编译并烧录Hello World程序
- [ ] 面包板连接完成
- [ ] 各传感器测试通过
- [ ] OLED显示测试通过
- [ ] RFID读卡测试通过
- [ ] 串口通信测试通过
- [ ] 中断功能测试通过
- [ ] 系统集成测试通过
- [ ] 文档编写完成
- [ ] 演示准备完成

---

**祝您课设顺利，取得优异成绩！** 🎉
